<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/blogs/icon.png"><meta name="generator" content="Astro v5.16.6"><!-- Fonts --><!-- Font styles --><!-- Preload font files --><link rel="preload" href="/blogs/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/blogs/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://laudantstolam.github.io/blogs/windows-kernel-101/"><!-- Primary Meta Tags --><title>Windows Kernel 101</title><meta name="title" content="Windows Kernel 101"><meta name="description" content="w/ Holyhigh , Angelboy"><meta name="keywords" content="#notes, #è³‡å®‰, Windows"><!-- Robots Meta Tags --><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://laudantstolam.github.io/blogs/windows-kernel-101/"><meta property="og:title" content="Windows Kernel 101"><meta property="og:description" content="w/ Holyhigh , Angelboy"><meta property="og:image" content="https://laudantstolam.github.io/blogs/windows-kernel-101/null"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://laudantstolam.github.io/blogs/windows-kernel-101/"><meta property="twitter:title" content="Windows Kernel 101"><meta property="twitter:description" content="w/ Holyhigh , Angelboy"><meta property="twitter:image" content="https://laudantstolam.github.io/blogs/windows-kernel-101/null"><!-- KaTeX CSS for LaTeX rendering --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><link rel="stylesheet" href="/blogs/_astro/_slug_.xWQ6d_73.css">
<link rel="stylesheet" href="/blogs/_astro/_slug_.CxGNqR4v.css">
<link rel="stylesheet" href="/blogs/_astro/_slug_.k20Gn5Lx.css"></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="nav-wrapper" data-astro-cid-3ef6ksr2> <!-- <div class="nav-brand">
				<a href={getUrl('/')} class="brand-link">
					<div class="brand-icon">
						<img src={getUrl('/icon.png')} alt="icon logo" width="24" height="24" />
					</div>
					<span class="brand-text">{SITE_TITLE}</span>
				</a>
			</div> --> <div class="nav-links" data-astro-cid-3ef6ksr2> <a href="/blogs/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blogs/blog" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/blogs/projects" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Projects </a>  </div> <div class="nav-actions" data-astro-cid-3ef6ksr2> <button id="theme-toggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme" data-astro-cid-x3pjskd3> <svg width="20" height="20" viewBox="0 0 24 24" class="sun-icon" data-astro-cid-x3pjskd3> <path fill="currentColor" d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" data-astro-cid-x3pjskd3></path> </svg> <svg width="20" height="20" viewBox="0 0 24 24" class="moon-icon" data-astro-cid-x3pjskd3> <path fill="currentColor" d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.94174 4 12Z" data-astro-cid-x3pjskd3></path> </svg> </button>  <script type="module">const m=document.getElementById("theme-toggle");function t(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}function o(){const n=(document.documentElement.getAttribute("data-theme")||"dark")==="light"?"dark":"light";t(n)}function d(){const e=localStorage.getItem("theme");t(e||"dark")}m?.addEventListener("click",o);document.addEventListener("DOMContentLoaded",d);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem("theme")||t("dark")});</script> <a href="https://github.com/laudantstolam" target="_blank" class="social-link" aria-label="GitHub" data-astro-cid-3ef6ksr2> <svg viewBox="0 0 16 16" aria-hidden="true" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2025-12-21T00:00:00.000Z"> Dec 21, 2025 </time>  </div> <h1 data-astro-cid-bvzihdzo>Windows Kernel 101</h1>  <div class="tags" data-astro-cid-bvzihdzo> <a href="/blogs/tag/#notes/" class="tag" data-astro-cid-bvzihdzo>##notes</a><a href="/blogs/tag/#è³‡å®‰/" class="tag" data-astro-cid-bvzihdzo>##è³‡å®‰</a><a href="/blogs/tag/Windows/" class="tag" data-astro-cid-bvzihdzo>#Windows</a> </div>  </div> <!-- Table of Contents --> <aside class="toc-wrapper" id="toc-wrapper" data-astro-cid-bvzihdzo> <div class="toc-header" data-astro-cid-bvzihdzo> <div class="toc-title" data-astro-cid-bvzihdzo> <span data-astro-cid-bvzihdzo>ğŸ‘€</span> <button class="toc-minimize-btn" id="toc-minimize-btn" aria-label="Toggle TOC" data-astro-cid-bvzihdzo> <span id="toc-icon" data-astro-cid-bvzihdzo>âˆ’</span> </button> </div> </div> <div class="toc-content" data-astro-cid-bvzihdzo> <ul class="toc-list" id="toc-list" data-astro-cid-bvzihdzo></ul> </div> </aside>  <details data-callout="" data-callout-type="quote" open>
<summary data-callout-title="">ç’°å¢ƒè¨­å®š</summary>
<div data-callout-body="">
<p><strong>VM-win11 25H2</strong></p>
<ul>
<li>é–‹debug mode</li>
<li>è¨­å®š<code>bcdedit /dbgsettings net hostip:&#x3C;Host_IP> port:50000 key:1.2.3.4</code>
<img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20251221104913.png" alt="image.png|250"></li>
<li>Load Driver
<ul>
<li><code>sc create vulnD type=kernel binPath= "VulDriver.sys"</code></li>
<li><code>sc [start/stop/delete] vulnD</code>
<strong>HOST</strong></li>
</ul>
</li>
<li>WINDBG è¨­å®š</li>
<li>kernel attach è¨­å®šVM IPè·Ÿ ä¸Šé¢è¨­å®šçš„port/key</li>
</ul>
</div>
</details>
<details data-callout="" data-callout-type="tldr" open>
<summary data-callout-title="">Tldr</summary>
<div data-callout-body="">
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/NotebookLM%20Mind%20Map%20(1).png" alt=""></p>
</div>
</details>
<h1 id="winbasic--windbg-basic">WinBasic &#x26; Windbg Basic</h1>
<h4 id="process-in-windbg">process in windbg</h4>
<ul>
<li>eprocess
<code>!process</code></li>
</ul>
<h4 id="threads-in-windbg">threads in windbg</h4>
<ul>
<li>etheads</li>
<li>kthreads</li>
<li>irplist</li>
</ul>
<h3 id="æ¬Šé™ç›¸é—œèƒŒæ™¯çŸ¥è­˜">æ¬Šé™ç›¸é—œèƒŒæ™¯çŸ¥è­˜</h3>
<h4 id="integrity-level">Integrity Level</h4>
<p>ä¸€èˆ¬éƒ½æ˜¯medium-low
å¯ä»¥æ‰‹å‹•èª¿æ•´ <code>icacls ImageFile /setintegritylevel Low</code> (åªèƒ½è¨­å®šæˆæ¯”è‡ªå·±ä½çš„)
<img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20251221113916.png" alt="image.png|500"></p>
<h4 id="dacl">DACL</h4>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20251221114238.png" alt="image.png|225"></p>
<h4 id="sid-ç›£æ§">SID ç›£æ§</h4>
<ul>
<li>tool: PsGetSid.exe</li>
</ul>
<h4 id="privillages">Privillages</h4>
<ul>
<li>super previllage</li>
</ul>
<h4 id="token">Token</h4>
<ul>
<li>èª¿æ•´: AdjustTokenPrivileges</li>
<li>è¦æ”¹è‡³å°‘éœ€è¦æ˜¯high level</li>
<li><code>!token [address of _TOKEN]</code>
<ul>
<li>æŸ¥çœ‹è©² token çš„è³‡è¨Š</li>
</ul>
</li>
<li><code>dt _token [address of _TOKEN]</code></li>
</ul>
<h4 id="access-check">Access check</h4>
<ul>
<li><code>!object [address of object]</code></li>
<li><code>dt _OBJECT_HEADER [address of object header]</code></li>
<li><code>!sd [address of SD] &#x26; -10</code></li>
</ul>
<h3 id="è¨˜æ†¶é«”ç›¸é—œèƒŒæ™¯çŸ¥è­˜">è¨˜æ†¶é«”ç›¸é—œèƒŒæ™¯çŸ¥è­˜</h3>
<h4 id="pages">Pages</h4>
<ul>
<li>å·²ç¶“commit/release å‡ºå»çš„Instruction</li>
<li>Use page table tot turn VA to PA
<strong>Demand Paging</strong> -> thread è¦accessæ‰alloc</li>
</ul>
<h4 id="tlp">TLP</h4>
<p>å› ç‚ºæ¯æ¬¡éƒ½è¦å¾ˆä¹…æ‰€ä»¥æäº†ä¸€å€‹Page Label</p>
<h4 id="page-table">Page Table</h4>
<h3 id="pte">PTE</h3>
<h5 id="lab0---æ‰‹å‹•è§£æè™›æ“¬ä½å€--ç‰©ç†ä½å€">LAB0 - æ‰‹å‹•è§£æè™›æ“¬ä½å€ â†’ ç‰©ç†ä½å€</h5>
<div class="expressive-code"><link rel="stylesheet" href="/blogs/_astro/ec.0niu6.css"><script type="module" src="/blogs/_astro/ec.8zarh.js"></script><figure class="frame"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#e1e4e8;--1:#24292e">@!PEX</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@!PEX"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="bash"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">k</span><span style="--0:#E1E4E8;--1:#24292E">d</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">lm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">m</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Browse</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">full</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">module</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">list</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">start</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">end</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">module</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">name</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#9ECBFF;--1:#032F62"> fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">774b6000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nt</span><span style="--0:#E1E4E8;--1:#24292E"> (pdb </span><span style="--0:#9ECBFF;--1:#032F62">symbols</span><span style="--0:#E1E4E8;--1:#24292E">) C:</span><span style="--0:#79B8FF;--1:#005CC5">\P</span><span style="--0:#E1E4E8;--1:#24292E">rogramData</span><span style="--0:#79B8FF;--1:#005CC5">\D</span><span style="--0:#E1E4E8;--1:#24292E">bg</span><span style="--0:#79B8FF;--1:#005CC5">\s</span><span style="--0:#E1E4E8;--1:#24292E">ym</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#E1E4E8;--1:#24292E">tkrnlmp.pdb</span><span style="--0:#79B8FF;--1:#005CC5">\E</span><span style="--0:#E1E4E8;--1:#24292E">0093F3AEF15D58168B753C9488A40431</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#E1E4E8;--1:#24292E">tkrnlmp.pdb Unable to enumerate kernel-mode unloaded modules, HRESULT 0x80004005</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">k</span><span style="--0:#E1E4E8;--1:#24292E">d</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cr3</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cr3=00000000001ad002</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">k</span><span style="--0:#E1E4E8;--1:#24292E">d</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">?</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">00000000001ad002</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0xFFFFFFFFFFFFF000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1757184</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad000</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> ? (fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">30</span><span style="--0:#E1E4E8;--1:#24292E">) &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0x1FF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">511</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">000001ff</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> ? (fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">39</span><span style="--0:#E1E4E8;--1:#24292E">) &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0x1FF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">127</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">0000007f</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> ? (fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">21</span><span style="--0:#E1E4E8;--1:#24292E">) &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0x1FF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000002</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> ? (fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">12</span><span style="--0:#E1E4E8;--1:#24292E">) &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0x1FF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">424</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">000001a8</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> ? (fffff805`</span><span style="--0:#B392F0;--1:#6F42C1">76a00000</span><span style="--0:#E1E4E8;--1:#24292E">) &#x26; </span><span style="--0:#B392F0;--1:#6F42C1">0xFFF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Evaluate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">expression:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">1:</span><span style="--0:#9ECBFF;--1:#032F62"> kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#9ECBFF;--1:#032F62"> dq /p @@(</span><span style="--0:#B392F0;--1:#6F42C1">0x1ad000</span><span style="--0:#9ECBFF;--1:#032F62"> + 127</span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#9ECBFF;--1:#032F62">8)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad3f8</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad408</span><span style="--0:#9ECBFF;--1:#032F62">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad418</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad428</span><span style="--0:#9ECBFF;--1:#032F62">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad438</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad448</span><span style="--0:#9ECBFF;--1:#032F62">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad458</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">001ad468</span><span style="--0:#9ECBFF;--1:#032F62">  </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">00000000</span><span style="--0:#9ECBFF;--1:#032F62">`</span><span style="--0:#B392F0;--1:#6F42C1">00000000</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="1: kd> lm m nt Browse full module list start end module name fffff805&#x60;76a00000 fffff805&#x60;774b6000 nt (pdb symbols) C:\ProgramData\Dbg\sym\ntkrnlmp.pdb\E0093F3AEF15D58168B753C9488A40431\ntkrnlmp.pdb Unable to enumerate kernel-mode unloaded modules, HRESULT 0x800040051: kd> r cr3 cr3=00000000001ad0021: kd> ? 00000000001ad002 &#x26; 0xFFFFFFFFFFFFF000 Evaluate expression: 1757184 = 00000000&#x60;001ad0001: kd> ? (fffff805&#x60;76a00000 >> 30) &#x26; 0x1FF Evaluate expression: 511 = 00000000&#x60;000001ff1: kd> ? (fffff805&#x60;76a00000 >> 39) &#x26; 0x1FF Evaluate expression: 127 = 00000000&#x60;0000007f1: kd> ? (fffff805&#x60;76a00000 >> 21) &#x26; 0x1FF Evaluate expression: 2 = 00000000&#x60;000000021: kd> ? (fffff805&#x60;76a00000 >> 12) &#x26; 0x1FF Evaluate expression: 424 = 00000000&#x60;000001a81: kd> ? (fffff805&#x60;76a00000) &#x26; 0xFFF Evaluate expression: 0 = 00000000&#x60;000000001: kd> dq /p @@(0x1ad000 + 127*8)00000000&#x60;001ad3f8  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad408  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad418  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad428  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad438  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad448  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad458  00000000&#x60;00000000 00000000&#x60;0000000000000000&#x60;001ad468  00000000&#x60;00000000 00000000&#x60;00000000"><div></div></button></div></figure></div>
<h1 id="windows-driver--vuln-hunting">Windows Driver &#x26; Vuln Hunting</h1>
<h4 id="win-driver">Win Driver</h4>
<ul>
<li>WDM (Windows Driver Model) ğŸŒŸ</li>
<li>KMDF (Kernel-Mode Driver Framework)</li>
<li>Win32k/GDI: ä¸€å †æ´</li>
<li>Mini-Filter : å°ˆé–€æ‹¿ä¾†hook (é¦¬å¸«ä»–è¶…æ„›</li>
</ul>
<h5 id="tool">TOOL</h5>
<ul>
<li>Winobj
<ul>
<li>device/objects</li>
</ul>
</li>
</ul>
<h4 id="irp-close-vs-cleanup">IRP Close v.s. Cleanup</h4>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E"> </span></span><span style="--0:#E1E4E8;--1:#24292E">DriverObject</span><span style="--0:#F97583;--1:#BF3441">-></span><span style="--0:#FFAB70;--1:#AE4B07">MajorFunction</span><span style="--0:#E1E4E8;--1:#24292E">[IRP_MJ_CLOSE] </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> VulClose ;</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972">// release file obj</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E"> </span></span><span style="--0:#E1E4E8;--1:#24292E">DriverObject</span><span style="--0:#F97583;--1:#BF3441">-></span><span style="--0:#FFAB70;--1:#AE4B07">MajorFunction</span><span style="--0:#E1E4E8;--1:#24292E">[IRP_MJ_CLEANUP] </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> VulCleanUp;</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972">// é—œæ‰æœ€å¾Œä¸€å€‹handler</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=" DriverObject->MajorFunction[IRP_MJ_CLOSE] = VulClose ; // release file obj DriverObject->MajorFunction[IRP_MJ_CLEANUP] = VulCleanUp; // é—œæ‰æœ€å¾Œä¸€å€‹handler"><div></div></button></div></figure></div>
<p>ä¸å¤ªä¸€æ¨£ close æœƒåˆªæ‰reference count, clean up ä¸æœƒ(è½èªªé€™é‚Šæ›¾ç¶“æœ‰æ´)
(gpt å°æ•´ç†)</p>
<ol>
<li>
<p><strong>Cleanup (<strong><strong>IRP_MJ_CLEANUP</strong></strong>)</strong>ï¼š</p>
<ul>
<li><strong>è§¸ç™¼æ™‚æ©Ÿ</strong>ï¼šç•¶ User Mode æ‡‰ç”¨ç¨‹å¼å°è£ç½®çš„ <strong>Handle æ•¸ç›®é™ç‚º 0</strong> æ™‚è§¸ç™¼ï¼ˆä¾‹å¦‚æ‡‰ç”¨ç¨‹å¼å‘¼å« <code>CloseHandle</code> æˆ–å´©æ½°é—œé–‰ï¼‰</li>
<li><strong>ç›®çš„</strong>ï¼šå–æ¶ˆè©² Handle å°šæœªå®Œæˆçš„ I/O è«‹æ±‚ï¼Œæ¸…ç†èˆ‡è©² Handle ç›¸é—œçš„ Contextï¼ˆå¦‚æ•™æ ä¸­æ¸…ç† <code>FileObject</code> ç›¸é—œè³‡æ–™ï¼‰ã€‚æ­¤æ™‚ Kernel è£¡çš„ File Object é‚„æ²’è¢«éŠ·æ¯€ï¼Œåªæ˜¯ User å·²ç¶“ä¸æ¡æœ‰ Handle äº†ã€‚</li>
</ul>
</li>
<li>
<p><strong>Close (<strong><strong>IRP_MJ_CLOSE</strong></strong>)</strong>ï¼š</p>
<ul>
<li><strong>è§¸ç™¼æ™‚æ©Ÿ</strong>ï¼šç•¶è©² File Object çš„ <strong>Reference Count (åƒç…§è¨ˆæ•¸) é™ç‚º 0</strong> æ™‚è§¸ç™¼ã€‚é€™é€šå¸¸ç™¼ç”Ÿåœ¨ Cleanup ä¹‹å¾Œã€‚</li>
<li>ç›®çš„ï¼šçœŸæ­£éŠ·æ¯€ File Objectã€‚é€™ä»£è¡¨ç³»çµ±ä¸­å†ä¹Ÿæ²’æœ‰ä»»ä½•å…ƒä»¶ï¼ˆåŒ…å« User Application æˆ–å…¶ä»– Kernel Driverï¼‰æŒ‡æ¶‰åˆ°é€™å€‹ç‰©ä»¶äº†ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ç¸½çµï¼š</strong> å¯« Driver æ™‚è¦å…ˆå¯« <code>DriverEntry</code> åˆå§‹æ‰€æœ‰å…¥å£ï¼Œè¨˜å¾—åœ¨ <code>Unload</code> æŠŠå»ºå‡ºä¾†çš„æ±è¥¿ï¼ˆDevice/SymLinkï¼‰åˆªæ‰ã€‚è€Œåœ¨è™•ç†é—œé–‰è«‹æ±‚æ™‚ï¼Œé€šå¸¸æœƒåœ¨ <code>Cleanup</code> éšæ®µé‡‹æ”¾è·Ÿ User Handle ç¶å®šçš„è³‡æºï¼Œ<code>Close</code> å‰‡æ˜¯ç‰©ä»¶ç”Ÿå‘½é€±æœŸçš„æœ€å¾Œçµ‚çµã€‚</p>
<h4 id="ioåœ¨ç³»çµ±è£¡é¢æ€éº¼è™•ç†çš„">IOåœ¨ç³»çµ±è£¡é¢æ€éº¼è™•ç†çš„</h4>
<p>User data handling</p>
<ul>
<li>buffer IO</li>
<li>direct IO</li>
<li>neither nor</li>
</ul>
<h4 id="é¸æ“‡é©åˆçš„å­˜å–æ–¹æ³•">é¸æ“‡é©åˆçš„å­˜å–æ–¹æ³•</h4>
<p>API: <code>IRP_MJ_*</code></p>





















<table><thead><tr><th>READ/WRITE</th><th>DEVICE_CONTROL/INTERNAL_DEVICE_CONTROL</th></tr></thead><tbody><tr><td>DEVICE_OBJECT ä¸­çš„Flags æ¬„ä½æ±ºå®š</td><td>IOCTL code è£¡é¢çš„methodé …ç›®</td></tr><tr><td></td><td><code>CTL_CODE(DeviceType, Function, Method, Access)</code></td></tr><tr><td></td><td>é€™é‚Šçš„Accessæ˜¯åœ¨NTCreateFileçš„æ™‚å€™æŒ‡å®šçš„---^</td></tr></tbody></table>
<h5 id="ç´°èªªaccess">ç´°èªªAccess</h5>
<p>ä¸€èˆ¬ä¾†èªªæœƒçµ¦åˆ°æœ€å¤§ â€”> MAXIMUM_ALLOWED</p>
<ul>
<li>å˜—è©¦ç”¨ <code>CreateFile(..., MAXIMUM_ALLOWED, ...)</code> æ‰“é–‹é©…å‹•è£ç½®ã€‚</li>
<li>å¦‚æœå¤±æ•—ï¼Œå°±æ”¹ç”¨æœ€ä½é™åº¦çš„æ¬Šé™ (<code>FILE_READ_ATTRIBUTES | SYNCHRONIZE</code>)ã€‚</li>
<li>é›–ç„¶é€™æ¨£ä¸èƒ½åšè®€å¯«ï¼Œä½†ä»ç„¶å¯ä»¥ç™¼é€ <code>FILE_ANY_ACCESS</code> çš„ IOCTLï¼Œè·Ÿé©…å‹•äº’å‹•ã€‚</li>
</ul>
<h3 id="lab1---emunerating-services">LAB1 - Emunerating Services</h3>
<details data-callout="" data-callout-type="check" open>
<summary data-callout-title="">LAB1</summary>
<div data-callout-body="">
<p></p>
<p>å˜—è©¦åˆ©ç”¨DeviceIoControlèˆ‡driver(VulDriver.sys) äº’å‹•
â€¢ ç™¼é€ç‰¹å®šçš„IOCTL_VUL_TESTä¸¦è®€å‡ºçµæœ(HelloWorld)
â€¢ ç·´ç¿’æ–·é»ï¼Œä¸¦è§€å¯ŸIRPå…§å®¹</p>
<hr>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;windows.h></span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;winternl.h></span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;stdio.h></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">DIRECTORY_QUERY</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">0001</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">OBJ_CASE_INSENSITIVE</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">00000040</span><span style="--0:#F97583;--1:#BF3441">L</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">FILE_NON_DIRECTORY_FILE</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">00000040</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">FILE_SYNCHRONOUS_IO_NONALERT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">00000020</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#pragma</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">comment</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#B392F0;--1:#6F42C1">lib</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#9ECBFF;--1:#032F62">"ntdll.lib"</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">typedef</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> _OBJECT_DIRECTORY_INFORMATION {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING Name;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING TypeName;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">} OBJECT_DIRECTORY_INFORMATION, </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> POBJECT_DIRECTORY_INFORMATION;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">typedef</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NTSTATUS</span><span style="--0:#E1E4E8;--1:#24292E">(NTAPI</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">PNtOpenDirectoryObject</span><span style="--0:#E1E4E8;--1:#24292E">)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">typedef</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NTSTATUS</span><span style="--0:#E1E4E8;--1:#24292E">(NTAPI</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">PNtQueryDirectoryObject</span><span style="--0:#E1E4E8;--1:#24292E">)(HANDLE, PVOID, ULONG, BOOLEAN, BOOLEAN, PULONG, PULONG);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">typedef</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NTSTATUS</span><span style="--0:#E1E4E8;--1:#24292E">(NTAPI</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">PNtOpenFile</span><span style="--0:#E1E4E8;--1:#24292E">)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES, PIO_STATUS_BLOCK, ULONG, ULONG);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">ListAndTestDevices</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">HMODULE hNtdll </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">GetModuleHandleA</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"ntdll.dll"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">PNtOpenDirectoryObject NtOpenDirectoryObject </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (PNtOpenDirectoryObject)</span><span style="--0:#B392F0;--1:#6F42C1">GetProcAddress</span><span style="--0:#E1E4E8;--1:#24292E">(hNtdll, </span><span style="--0:#9ECBFF;--1:#032F62">"NtOpenDirectoryObject"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">PNtQueryDirectoryObject NtQueryDirectoryObject </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (PNtQueryDirectoryObject)</span><span style="--0:#B392F0;--1:#6F42C1">GetProcAddress</span><span style="--0:#E1E4E8;--1:#24292E">(hNtdll, </span><span style="--0:#9ECBFF;--1:#032F62">"NtQueryDirectoryObject"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">PNtOpenFile NtOpenFile </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (PNtOpenFile)</span><span style="--0:#B392F0;--1:#6F42C1">GetProcAddress</span><span style="--0:#E1E4E8;--1:#24292E">(hNtdll, </span><span style="--0:#9ECBFF;--1:#032F62">"NtOpenFile"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">HANDLE hDir;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">OBJECT_ATTRIBUTES attr;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING dirName;</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">RtlInitUnicodeString</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">dirName, L</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Device"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">InitializeObjectAttributes</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">attr, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">dirName, OBJ_CASE_INSENSITIVE, </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">NTSTATUS status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NtOpenDirectoryObject</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">hDir, DIRECTORY_QUERY, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">attr);</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (status </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"Failed to open </span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Device. Status: 0x</span><span style="--0:#79B8FF;--1:#005CC5">%08X\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, status);</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#99A0A6;--1:#616972">// Use a larger buffer to ensure we catch the first batch of entries</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">BYTE </span><span style="--0:#FFAB70;--1:#AE4B07">buffer</span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#79B8FF;--1:#005CC5">8192</span><span style="--0:#E1E4E8;--1:#24292E">];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">ULONG context </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">, returnLength </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">%-35s</span><span style="--0:#9ECBFF;--1:#032F62"> | </span><span style="--0:#79B8FF;--1:#005CC5">%-15s</span><span style="--0:#9ECBFF;--1:#032F62"> | </span><span style="--0:#79B8FF;--1:#005CC5">%-15s\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#9ECBFF;--1:#032F62">"Device Name"</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#9ECBFF;--1:#032F62">"Type"</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#9ECBFF;--1:#032F62">"Status (Hex)"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"-------------------------------------------------------------------------------------</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#99A0A6;--1:#616972">// Query the directory. If status is STATUS_NO_MORE_ENTRIES (0x80000006), the loop ends.</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> ((status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NtQueryDirectoryObject</span><span style="--0:#E1E4E8;--1:#24292E">(hDir, buffer, </span><span style="--0:#F97583;--1:#BF3441">sizeof</span><span style="--0:#E1E4E8;--1:#24292E">(buffer), </span><span style="--0:#79B8FF;--1:#005CC5">FALSE</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#79B8FF;--1:#005CC5">FALSE</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">context, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">returnLength)) </span><span style="--0:#F97583;--1:#BF3441">>=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">       </span></span><span style="--0:#E1E4E8;--1:#24292E">POBJECT_DIRECTORY_INFORMATION info </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (POBJECT_DIRECTORY_INFORMATION)buffer;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> (info->Name.Buffer </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x26;&#x26;</span><span style="--0:#E1E4E8;--1:#24292E"> info->Name.Length </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#99A0A6;--1:#616972">// Build full path safely</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">WCHAR </span><span style="--0:#FFAB70;--1:#AE4B07">fullPath</span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#79B8FF;--1:#005CC5">512</span><span style="--0:#E1E4E8;--1:#24292E">] </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> { </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> };</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#B392F0;--1:#6F42C1">wcscpy_s</span><span style="--0:#E1E4E8;--1:#24292E">(fullPath, </span><span style="--0:#79B8FF;--1:#005CC5">512</span><span style="--0:#E1E4E8;--1:#24292E">, L</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Device</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#B392F0;--1:#6F42C1">wcsncat_s</span><span style="--0:#E1E4E8;--1:#24292E">(fullPath, </span><span style="--0:#79B8FF;--1:#005CC5">512</span><span style="--0:#E1E4E8;--1:#24292E">, info->Name.Buffer, info->Name.Length </span><span style="--0:#F97583;--1:#BF3441">/</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">sizeof</span><span style="--0:#E1E4E8;--1:#24292E">(WCHAR));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING uDevName;</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#B392F0;--1:#6F42C1">RtlInitUnicodeString</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">uDevName, fullPath);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">OBJECT_ATTRIBUTES devAttr;</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#B392F0;--1:#6F42C1">InitializeObjectAttributes</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">devAttr, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">uDevName, OBJ_CASE_INSENSITIVE, </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">HANDLE hDevice </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">IO_STATUS_BLOCK ioStatus;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">NTSTATUS openStatus </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">NtOpenFile</span><span style="--0:#E1E4E8;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">hDevice,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">               </span></span><span style="--0:#E1E4E8;--1:#24292E">GENERIC_READ </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> SYNCHRONIZE,</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">devAttr,</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">ioStatus,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">               </span></span><span style="--0:#E1E4E8;--1:#24292E">FILE_SHARE_READ </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> FILE_SHARE_WRITE,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">               </span></span><span style="--0:#E1E4E8;--1:#24292E">FILE_NON_DIRECTORY_FILE </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> FILE_SYNCHRONOUS_IO_NONALERT</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">%</span><span style="--0:#9ECBFF;--1:#032F62">-35wZ | </span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">%</span><span style="--0:#9ECBFF;--1:#032F62">-15wZ | "</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">info->Name, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">info->TypeName);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (openStatus </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"[ SUCCESS ] 0x</span><span style="--0:#79B8FF;--1:#005CC5">%08X\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, openStatus);</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#B392F0;--1:#6F42C1">CloseHandle</span><span style="--0:#E1E4E8;--1:#24292E">(hDevice);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#F97583;--1:#BF3441">else</span><span style="--0:#E1E4E8;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"[  FAIL   ] 0x</span><span style="--0:#79B8FF;--1:#005CC5">%08X\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, openStatus);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">           </span></span><span style="--0:#E1E4E8;--1:#24292E">info</span><span style="--0:#F97583;--1:#BF3441">++</span><span style="--0:#E1E4E8;--1:#24292E">;</span><span style="--0:#99A0A6;--1:#616972"> // Advance pointer</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">       </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#99A0A6;--1:#616972">// If the buffer was exactly full, there might be more, but usually context handles this.</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (status </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">80000006</span><span style="--0:#E1E4E8;--1:#24292E">) </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">   </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">CloseHandle</span><span style="--0:#E1E4E8;--1:#24292E">(hDir);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">main</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">ListAndTestDevices</span><span style="--0:#E1E4E8;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#9ECBFF;--1:#032F62">Done. Press any key..."</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#B392F0;--1:#6F42C1">getchar</span><span style="--0:#E1E4E8;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include <windows.h>#include <winternl.h>#include <stdio.h>#define DIRECTORY_QUERY 0x0001#define OBJ_CASE_INSENSITIVE 0x00000040L#define FILE_NON_DIRECTORY_FILE 0x00000040#define FILE_SYNCHRONOUS_IO_NONALERT 0x00000020#pragma comment(lib, &#x22;ntdll.lib&#x22;)typedef struct _OBJECT_DIRECTORY_INFORMATION {   UNICODE_STRING Name;   UNICODE_STRING TypeName;} OBJECT_DIRECTORY_INFORMATION, * POBJECT_DIRECTORY_INFORMATION;typedef NTSTATUS(NTAPI* PNtOpenDirectoryObject)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES);typedef NTSTATUS(NTAPI* PNtQueryDirectoryObject)(HANDLE, PVOID, ULONG, BOOLEAN, BOOLEAN, PULONG, PULONG);typedef NTSTATUS(NTAPI* PNtOpenFile)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES, PIO_STATUS_BLOCK, ULONG, ULONG);void ListAndTestDevices() {   HMODULE hNtdll = GetModuleHandleA(&#x22;ntdll.dll&#x22;);   PNtOpenDirectoryObject NtOpenDirectoryObject = (PNtOpenDirectoryObject)GetProcAddress(hNtdll, &#x22;NtOpenDirectoryObject&#x22;);   PNtQueryDirectoryObject NtQueryDirectoryObject = (PNtQueryDirectoryObject)GetProcAddress(hNtdll, &#x22;NtQueryDirectoryObject&#x22;);   PNtOpenFile NtOpenFile = (PNtOpenFile)GetProcAddress(hNtdll, &#x22;NtOpenFile&#x22;);   HANDLE hDir;   OBJECT_ATTRIBUTES attr;   UNICODE_STRING dirName;   RtlInitUnicodeString(&#x26;dirName, L&#x22;\\Device&#x22;);   InitializeObjectAttributes(&#x26;attr, &#x26;dirName, OBJ_CASE_INSENSITIVE, NULL, NULL);   NTSTATUS status = NtOpenDirectoryObject(&#x26;hDir, DIRECTORY_QUERY, &#x26;attr);   if (status != 0) {       printf(&#x22;Failed to open \\Device. Status: 0x%08X\n&#x22;, status);       return;   }   // Use a larger buffer to ensure we catch the first batch of entries   BYTE buffer[8192];   ULONG context = 0, returnLength = 0;   printf(&#x22;%-35s | %-15s | %-15s\n&#x22;, &#x22;Device Name&#x22;, &#x22;Type&#x22;, &#x22;Status (Hex)&#x22;);   printf(&#x22;-------------------------------------------------------------------------------------\n&#x22;);   // Query the directory. If status is STATUS_NO_MORE_ENTRIES (0x80000006), the loop ends.   while ((status = NtQueryDirectoryObject(hDir, buffer, sizeof(buffer), FALSE, FALSE, &#x26;context, &#x26;returnLength)) >= 0) {       POBJECT_DIRECTORY_INFORMATION info = (POBJECT_DIRECTORY_INFORMATION)buffer;       while (info->Name.Buffer != NULL &#x26;&#x26; info->Name.Length > 0) {           // Build full path safely           WCHAR fullPath[512] = { 0 };           wcscpy_s(fullPath, 512, L&#x22;\\Device\\&#x22;);           wcsncat_s(fullPath, 512, info->Name.Buffer, info->Name.Length / sizeof(WCHAR));           UNICODE_STRING uDevName;           RtlInitUnicodeString(&#x26;uDevName, fullPath);           OBJECT_ATTRIBUTES devAttr;           InitializeObjectAttributes(&#x26;devAttr, &#x26;uDevName, OBJ_CASE_INSENSITIVE, NULL, NULL);           HANDLE hDevice = NULL;           IO_STATUS_BLOCK ioStatus;           NTSTATUS openStatus = NtOpenFile(               &#x26;hDevice,               GENERIC_READ | SYNCHRONIZE,               &#x26;devAttr,               &#x26;ioStatus,               FILE_SHARE_READ | FILE_SHARE_WRITE,               FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT           );           printf(&#x22;%-35wZ | %-15wZ | &#x22;, &#x26;info->Name, &#x26;info->TypeName);           if (openStatus == 0) {               printf(&#x22;[ SUCCESS ] 0x%08X\n&#x22;, openStatus);               CloseHandle(hDevice);           }           else {               printf(&#x22;[  FAIL   ] 0x%08X\n&#x22;, openStatus);           }           info++; // Advance pointer       }       // If the buffer was exactly full, there might be more, but usually context handles this.       if (status == 0x80000006) break;   }   CloseHandle(hDir);}int main() {   ListAndTestDevices();   printf(&#x22;\nDone. Press any key...&#x22;);   getchar();   return 0;}"><div></div></button></div></figure></div>
</div>
</details>
<h3 id="ioctl">IOCTL</h3>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20251226202252.png" alt="image.png"></p>
<h3 id="lab2">LAB2</h3>
<p>å˜—è©¦åˆ©ç”¨DeviceIoControlèˆ‡driver(VulDriver.sys) äº’å‹•
â€¢ ç™¼é€ç‰¹å®šçš„IOCTL_VUL_TESTä¸¦è®€å‡ºçµæœ(HelloWorld)
â€¢ ç·´ç¿’æ–·é»ï¼Œä¸¦è§€å¯ŸIRPå…§å®¹</p>
<p>è§€å¯Ÿdriver codeçš„è¨­å®š</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">NTSTATUS status;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING devName </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">RTL_CONSTANT_STRING</span><span style="--0:#E1E4E8;--1:#24292E">(L</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Device</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Vul"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">UNICODE_STRING symName </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">RTL_CONSTANT_STRING</span><span style="--0:#E1E4E8;--1:#24292E">(L</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">??</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Vul"</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="NTSTATUS status;UNICODE_STRING devName = RTL_CONSTANT_STRING(L&#x22;\\Device\\Vul&#x22;);UNICODE_STRING symName = RTL_CONSTANT_STRING(L&#x22;\\??\\Vul&#x22;);"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">case IOCTL_VUL_TEST:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972">// æª¢æŸ¥ input buffer è‡³å°‘ 4 bytes</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (irpSp->Parameters.DeviceIoControl.InputBufferLength </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">4</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_BUFFER_TOO_SMALL;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">magic </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">(ULONG</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">)Irp->AssociatedIrp.SystemBuffer;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (magic </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">13371337</span><span style="--0:#E1E4E8;--1:#24292E">) {</span><span style="--0:#99A0A6;--1:#616972"> // é€™é‚Šçš„buffer sizeè¦ç‰¹åˆ¥çœ‹ä¸€ä¸‹</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_INVALID_PARAMETER;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">const</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">wchar_t</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> msg </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> L</span><span style="--0:#9ECBFF;--1:#032F62">"HelloWorld"</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">ULONG bytes </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (ULONG)((</span><span style="--0:#B392F0;--1:#6F42C1">wcslen</span><span style="--0:#E1E4E8;--1:#24292E">(msg) </span><span style="--0:#F97583;--1:#BF3441">+</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">) </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">sizeof</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#79B8FF;--1:#005CC5">wchar_t</span><span style="--0:#E1E4E8;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972">// æª¢æŸ¥ output buffer</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (irpSp->Parameters.DeviceIoControl.OutputBufferLength </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">1337</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_BUFFER_TOO_SMALL;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">RtlCopyMemory</span><span style="--0:#E1E4E8;--1:#24292E">(Irp->AssociatedIrp.SystemBuffer, msg, bytes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">info </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> bytes;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_SUCCESS;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="case IOCTL_VUL_TEST:{  // æª¢æŸ¥ input buffer è‡³å°‘ 4 bytes    if (irpSp->Parameters.DeviceIoControl.InputBufferLength < 4) {        status = STATUS_BUFFER_TOO_SMALL;        break;    }    magic = *(ULONG*)Irp->AssociatedIrp.SystemBuffer;    if (magic != 0x13371337) { // é€™é‚Šçš„buffer sizeè¦ç‰¹åˆ¥çœ‹ä¸€ä¸‹        status = STATUS_INVALID_PARAMETER;        break;    }    const wchar_t* msg = L&#x22;HelloWorld&#x22;;    ULONG bytes = (ULONG)((wcslen(msg) + 1) * sizeof(wchar_t));  // æª¢æŸ¥ output buffer    if (irpSp->Parameters.DeviceIoControl.OutputBufferLength < 0x1337) {        status = STATUS_BUFFER_TOO_SMALL;        break;    }    RtlCopyMemory(Irp->AssociatedIrp.SystemBuffer, msg, bytes);    info = bytes;    status = STATUS_SUCCESS;    break;}"><div></div></button></div></figure></div>
<p>ä¸»è¦æ³¨æ„çš„å°±æ˜¯bufferè·Ÿmagicçš„å€¼</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;windows.h></span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;stdio.h></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">FILE_DEVICE_VUL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">8000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">#define</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">IOCTL_VUL_TEST</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">CTL_CODE</span><span style="--0:#E1E4E8;--1:#24292E">(FILE_DEVICE_VUL, </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">800</span><span style="--0:#E1E4E8;--1:#24292E">, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">main</span><span style="--0:#E1E4E8;--1:#24292E">()</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">HANDLE hDevice </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">CreateFileW</span><span style="--0:#E1E4E8;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">L</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">\\\\</span><span style="--0:#9ECBFF;--1:#032F62">.</span><span style="--0:#79B8FF;--1:#005CC5">\\</span><span style="--0:#9ECBFF;--1:#032F62">Vul"</span><span style="--0:#E1E4E8;--1:#24292E">,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">GENERIC_READ </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> GENERIC_WRITE,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span><span style="--0:#E1E4E8;--1:#24292E">,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">OPEN_EXISTING,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">FILE_ATTRIBUTE_NORMAL,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">ULONG magic </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">13371337</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">wchar_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">outBuf</span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">2000</span><span style="--0:#E1E4E8;--1:#24292E">] </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> { </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> };</span><span style="--0:#99A0A6;--1:#616972"> // >= 0x1337 (4919) bytes</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">DWORD bytesReturned </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"[DEBUG] Sending IOCTL_VUL_TEST with magic 0x</span><span style="--0:#79B8FF;--1:#005CC5">%X</span><span style="--0:#9ECBFF;--1:#032F62">...</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, magic);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">BOOL ok </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">DeviceIoControl</span><span style="--0:#E1E4E8;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">hDevice,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">IOCTL_VUL_TEST,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">magic,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">sizeof</span><span style="--0:#E1E4E8;--1:#24292E">(magic),</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">outBuf,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">sizeof</span><span style="--0:#E1E4E8;--1:#24292E">(outBuf),</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">bytesReturned,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">NULL</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">ok)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">DWORD err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">GetLastError</span><span style="--0:#E1E4E8;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">printf</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"[DEBUG] DeviceIoControl failed: </span><span style="--0:#79B8FF;--1:#005CC5">%lu\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, err);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">wprintf</span><span style="--0:#E1E4E8;--1:#24292E">(L</span><span style="--0:#9ECBFF;--1:#032F62">"[DEBUG] Returned </span><span style="--0:#79B8FF;--1:#005CC5">%lu</span><span style="--0:#9ECBFF;--1:#032F62"> bytes: </span><span style="--0:#79B8FF;--1:#005CC5">%s\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">, bytesReturned, outBuf);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">CloseHandle</span><span style="--0:#E1E4E8;--1:#24292E">(hDevice);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">getchar</span><span style="--0:#E1E4E8;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include <windows.h>#include <stdio.h>#define FILE_DEVICE_VUL 0x8000#define IOCTL_VUL_TEST CTL_CODE(FILE_DEVICE_VUL, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)int main(){    HANDLE hDevice = CreateFileW(        L&#x22;\\\\.\\Vul&#x22;,        GENERIC_READ | GENERIC_WRITE,        0,        NULL,        OPEN_EXISTING,        FILE_ATTRIBUTE_NORMAL,        NULL    );    ULONG magic = 0x13371337;    wchar_t outBuf[0x2000] = { 0 }; // >= 0x1337 (4919) bytes    DWORD bytesReturned = 0;    printf(&#x22;[DEBUG] Sending IOCTL_VUL_TEST with magic 0x%X...\n&#x22;, magic);    BOOL ok = DeviceIoControl(        hDevice,        IOCTL_VUL_TEST,        &#x26;magic,        sizeof(magic),        outBuf,        sizeof(outBuf),        &#x26;bytesReturned,        NULL    );    if (!ok)    {        DWORD err = GetLastError();        printf(&#x22;[DEBUG] DeviceIoControl failed: %lu\n&#x22;, err);    }    else    {        wprintf(L&#x22;[DEBUG] Returned %lu bytes: %s\n&#x22;, bytesReturned, outBuf);    }    CloseHandle(hDevice);    getchar();    return 0;}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">drvobj VulDriver </span><span style="--0:#79B8FF;--1:#005CC5">7</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">DriverEntry:   fffff8020f986000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">DriverStartIo: </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">0000000</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">DriverUnload:  fffff8020f981ad0</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">AddDevice:     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">0000000</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">Dispatch routines:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">0e</span><span style="--0:#E1E4E8;--1:#24292E">] IRP_MJ_DEVICE_CONTROL              fffff8020f981370  </span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">fffff8020f981370</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#79B8FF;--1:#005CC5">12</span><span style="--0:#E1E4E8;--1:#24292E">] IRP_MJ_CLEANUP                     fffff8020f9811f0  </span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">fffff8020f9811f0</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="0: kd> !drvobj VulDriver 7DriverEntry:   fffff8020f986000DriverStartIo: 00000000DriverUnload:  fffff8020f981ad0AddDevice:     00000000Dispatch routines:[0e] IRP_MJ_DEVICE_CONTROL              fffff8020f981370  +0xfffff8020f981370[12] IRP_MJ_CLEANUP                     fffff8020f9811f0  +0xfffff8020f9811f0"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#e1e4e8;--1:#24292e">.text:0000000140001370 VulDeviceControl</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=".text:0000000140001370 VulDeviceControl"><div></div></button></div></figure></div>
<h3 id="lab-3-5">LAB 3-5</h3>
<p>ç·´ç¿’é–‹å•ŸSpecial Pool (ntoskrnl.exe)
â€¢ è«‹å˜—è©¦è§¸ç™¼VulDriverä¸­IOCTL_VUL_ALLOC Integer overflow æ¼æ´
â€¢ è«‹å˜—è©¦è§¸ç™¼VulDriverä¸­IOCTL_VUL_GET_GLOBAL OOBçš„æ¼æ´
â€¢ è«‹å˜—è©¦è§¸ç™¼VulDriverä¸­IOCTL_VUL_GET_THREADIDUAF æ¼æ´</p>
<h4 id="lab3-integer-overflow">LAB3 Integer overflow</h4>
<p>æ¼æ´ä½ç½®</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">case IOCTL_VUL_ALLOC:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">pdata </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> PrivateData</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">)irpSp->FileObject->FsContext;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (irpSp->Parameters.DeviceIoControl.InputBufferLength </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">4</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_BUFFER_TOO_SMALL;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">size </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">(ULONG</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">)Irp->AssociatedIrp.SystemBuffer;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">ULONG allocate_size </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> size </span><span style="--0:#F97583;--1:#BF3441">+</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">0x</span><span style="--0:#79B8FF;--1:#005CC5">80</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">pdata->Buffer </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">ExAllocatePool2</span><span style="--0:#E1E4E8;--1:#24292E">(POOL_FLAG_NON_PAGED, allocate_size, </span><span style="--0:#9ECBFF;--1:#032F62">'Vul2'</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">pdata->Buffer) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_INSUFFICIENT_RESOURCES;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">info </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">pdata->BufferSize </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> size;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">status </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> STATUS_SUCCESS;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">info </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="case IOCTL_VUL_ALLOC:{    pdata = (struct PrivateData*)irpSp->FileObject->FsContext;    if (irpSp->Parameters.DeviceIoControl.InputBufferLength < 4) {        status = STATUS_BUFFER_TOO_SMALL;        break;    }    size = *(ULONG*)Irp->AssociatedIrp.SystemBuffer;    ULONG allocate_size = size + 0x80;    pdata->Buffer = ExAllocatePool2(POOL_FLAG_NON_PAGED, allocate_size, &#x27;Vul2&#x27;);    if (!pdata->Buffer) {        status = STATUS_INSUFFICIENT_RESOURCES;        info = 0;        break;    }    pdata->BufferSize = size;    status = STATUS_SUCCESS;    info = 0;    break;}"><div></div></button></div></figure></div>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20251228035505.png" alt="image.png"></p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="c"><code><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bp fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea1513</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bp fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea153A</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bp nt</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">ExAllocatePool2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bp fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea15F0</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bp nt</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">KeBugCheckEx</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">: kd</span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> bl</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea1370</span><span style="--0:#E1E4E8;--1:#24292E">     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) VulDriver</span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">1370</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea1513</span><span style="--0:#E1E4E8;--1:#24292E">     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) VulDriver</span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">1513</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">2</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea153a</span><span style="--0:#E1E4E8;--1:#24292E">     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) VulDriver</span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">153a</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">3</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`b4b680f0     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) nt</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">ExAllocatePool2</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">4</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`</span><span style="--0:#FDAEB7;--0fs:italic;--1:#B31D28;--1fs:italic">4aea15f0</span><span style="--0:#E1E4E8;--1:#24292E">     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) VulDriver</span><span style="--0:#F97583;--1:#BF3441">+0x</span><span style="--0:#79B8FF;--1:#005CC5">15f0</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#79B8FF;--1:#005CC5">5</span><span style="--0:#E1E4E8;--1:#24292E"> e Disable Clear  fffff806`b44fb310     </span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">0</span><span style="--0:#79B8FF;--1:#005CC5">001</span><span style="--0:#E1E4E8;--1:#24292E">) nt</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">KeBugCheckEx</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="0: kd> bp fffff806&#x60;4aea15130: kd> bp fffff806&#x60;4aea153A0: kd> bp nt!ExAllocatePool20: kd> bp fffff806&#x60;4aea15F00: kd> bp nt!KeBugCheckEx0: kd> bl     0 e Disable Clear  fffff806&#x60;4aea1370     0001 (0001) VulDriver+0x1370     1 e Disable Clear  fffff806&#x60;4aea1513     0001 (0001) VulDriver+0x1513     2 e Disable Clear  fffff806&#x60;4aea153a     0001 (0001) VulDriver+0x153a     3 e Disable Clear  fffff806&#x60;b4b680f0     0001 (0001) nt!ExAllocatePool2     4 e Disable Clear  fffff806&#x60;4aea15f0     0001 (0001) VulDriver+0x15f0     5 e Disable Clear  fffff806&#x60;b44fb310     0001 (0001) nt!KeBugCheckEx"><div></div></button></div></figure></div>
<p><a href="https://blog.talosintelligence.com/exploring-malicious-windows-drivers-part-2/">Exploring malicious Windows drivers (Part 2): the I/O system, IRPs, stack locations, IOCTLs and more</a></p>
<p><a href="https://ithelp.ithome.com.tw/articles/10323858">ã€ç¬¬ 07 è©±ã€‘é€†å‘åˆ†æ WDM é©…å‹•ç¨‹å¼ - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©</a></p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <div class="copyright" data-astro-cid-sz7xmlte>
&copy; 2026 Obsidian Blogger. All rights reserved.
</div> </div> </footer>  <script type="module" src="/blogs/_astro/BlogPost.astro_astro_type_script_index_0_lang.DG5eh-Mz.js"></script> </body> </html>