<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/blogs/icon.png"><meta name="generator" content="Astro v5.1.1"><!-- Fonts --><!-- Font styles --><!-- Preload font files --><link rel="preload" href="/blogs/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/blogs/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://laudantstolam.github.io/kyudobot/"><!-- Primary Meta Tags --><title>kyudobot</title><meta name="title" content="kyudobot"><meta name="description" content="箭矢落點辨識結合LINE聊天機器人自動化分析"><meta name="keywords" content="project"><!-- Robots Meta Tags --><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://laudantstolam.github.io/kyudobot/"><meta property="og:title" content="kyudobot"><meta property="og:description" content="箭矢落點辨識結合LINE聊天機器人自動化分析"><meta property="og:image" content="https://laudantstolam.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://laudantstolam.github.io/kyudobot/"><meta property="twitter:title" content="kyudobot"><meta property="twitter:description" content="箭矢落點辨識結合LINE聊天機器人自動化分析"><meta property="twitter:image" content="https://laudantstolam.github.io/blog-placeholder-1.jpg"><!-- KaTeX CSS for LaTeX rendering --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><link rel="stylesheet" href="/_astro/_slug_.DbJq119r.css">
<link rel="stylesheet" href="/_astro/_slug_.DnqyYaEC.css">
<link rel="stylesheet" href="/_astro/_slug_.BVeb309D.css">
<style>[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="nav-wrapper" data-astro-cid-3ef6ksr2> <!-- <div class="nav-brand">
				<a href={getUrl('/')} class="brand-link">
					<div class="brand-icon">
						<img src={getUrl('/icon.png')} alt="icon logo" width="24" height="24" />
					</div>
					<span class="brand-text">{SITE_TITLE}</span>
				</a>
			</div> --> <div class="nav-links" data-astro-cid-3ef6ksr2> <a href="/blogs/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blogs/blog" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/blogs/projects" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Projects </a>  </div> <div class="nav-actions" data-astro-cid-3ef6ksr2> <button id="theme-toggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme" data-astro-cid-x3pjskd3> <svg width="20" height="20" viewBox="0 0 24 24" class="sun-icon" data-astro-cid-x3pjskd3> <path fill="currentColor" d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" data-astro-cid-x3pjskd3></path> </svg> <svg width="20" height="20" viewBox="0 0 24 24" class="moon-icon" data-astro-cid-x3pjskd3> <path fill="currentColor" d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.94174 4 12Z" data-astro-cid-x3pjskd3></path> </svg> </button>  <script type="module">const m=document.getElementById("theme-toggle");function t(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}function o(){const n=(document.documentElement.getAttribute("data-theme")||"dark")==="light"?"dark":"light";t(n)}function d(){const e=localStorage.getItem("theme");t(e||"dark")}m?.addEventListener("click",o);document.addEventListener("DOMContentLoaded",d);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem("theme")||t("dark")});</script> <a href="https://github.com/laudantstolam" target="_blank" class="social-link" aria-label="GitHub" data-astro-cid-3ef6ksr2> <svg viewBox="0 0 16 16" aria-hidden="true" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo>  <h1 data-astro-cid-bvzihdzo>kyudobot</h1>  <div class="tags" data-astro-cid-bvzihdzo> <a href="/blogs/tag/project/" class="tag" data-astro-cid-bvzihdzo>#project</a> </div>  </div>  <details data-callout="" data-callout-type="note" open>
<summary data-callout-title="">Link</summary>
<div data-callout-body="">
<p>Github: <a href="https://github.com/laudantstolam/kyudou-bot">laudantstolam/kyudou-bot: a line bot for analyzing kyudou practice</a></p>
</div>
</details>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IgpGR4v5rs0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<h3 id="intro">Intro</h3>
<p>This is a line bot for analyzing kyudou practice, using AWS+LINEAPI</p>
<h3 id="sources">Sources</h3>
<p>AWS console
<img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207001049.png" alt=""></p>
<p>LINEBOT_LINK=<a href="https://lin.ee/ZyrxxzG">https://lin.ee/ZyrxxzG</a></p>
<hr>
<h3 id="documents">DOCUMENTS</h3>
<p>箭矢落點辨識結合LINE聊天機器人自動化分析</p>
<h4 id="壹摘要">壹、摘要</h4>
<p>一、	啟發
鑒於平時有在進行弓道運動時，經常遇到需要記錄練習情況卻苦於沒有合適的軟體與方式，而現今記錄冊也大多只有中靶率及手動輸入落點的功能，在大量練習的過程中，有時僅是以相機匆匆記錄下上靶情況，事後也鮮少從相簿中翻出整理，因此利用本次期末專題的時機，決意自行開發一個易於使用且方便快速的分析記錄。
二、	預期效果-LINE
在考慮到自身使用習慣、直覺程度以及便利性決定使用LINE BOT 作為接口進行開發，便於及時收發訊息與傳遞文字與圖片。在實際射箭的場景中，由於取箭速度較快，不一定有時間慢慢記錄下中靶情況，有時即使手機拍了也會忘了記錄下，期待在使用了LINEBOT後直接拍照上傳，便可以更好的記錄下練習情況。</p>
<h4 id="貳開發過程與專案架構">貳、	開發過程與專案架構</h4>
<p>一、	專案架構
本次專案的架構是以LINE的聊天機器人LINE BOT SDK模組進行開發，負責處理使用者交談互動與引導以及與資料處理流程的邏輯橋接，而後端開發則串接了AWS 的無伺服器服務lambda和API Gateway來進行路由提供服務。</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002001.png" alt="">
(圖一、程式流程圖)</p>
<p>由上圖一可見LINE BOT提供的功能主要分成三類，聯繫客服、設定預設資料以及本次專題的主軸-練習記錄。透過python撰寫LINEBOT回應順序與錯誤處理，也使用了不同的訊息模式比如快速回復與文字按鈕來增加使用的便利性。</p>
<p>二、	影像處理
在使用者傳送完圖片輸入”開始分析”或是達到支援上限的十張照片時，程式會將儲存到AWS S3的照片依次載入處理程序處理特徵與提取資料，最後將特徵資料匯整進行資料繪圖</p>
<p>甲、	圖片可用性預判—Yolov8 segmentation
在圖片進入程式開始提取特徵前，我們先使用了以自己以yolov8訓練的模型快速檢驗了圖片的可用性。模型的部分我們首先利用Rainbo平台針對不同場景的照片進行手動標註，透過多邊形圈選箭矢本身，而後利用旋轉、透視、鏡像等方式將原先46張的資料集訓練集擴充成710張圖片，並且分成650張訓練，41張驗證，19張測試。</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002111.png" alt="">
(圖二、框選預覽)</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002202.png" alt="">
(圖三、經由200次Epoch之訓練成果)</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002136.png" alt="">
(圖四、損失與準確度圖表)</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002247.png" alt="">
(圖五、模型處理測試結果)</p>
<p>乙、	箭矢落點分析
為了分析箭矢落點和入射角的資料，我們首先進行了箭矢落點和入射直線的特徵擬合。由於箭矢的顏色不同以及與靶及後方土坡的顏色和明度相似，我們結合了不同的顏色空間範圍進行篩選後，再使用CANNY輪廓檢測和基本的侵蝕擴張方法調適參數過濾出較為乾淨的影像進行累積機率霍夫直線偵測(HoughLinesP)。並透過不同閥值的調整和對線條間隙、重疊度的排除，進行箭矢偵測，由下圖六所示，
並在此記錄下直線的兩點:入射點和直線尾端，用以之後進行轉置</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002425.png" alt="">
(圖六、圖片處理過程)</p>
<p>係箭矢的陰影會在直線判斷時干擾偵測結果，我們後續調整了不同的係數與各項處理的迭代數量並將重疊與間距拉大，得到以下圖七中的結果。</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002443.png" alt="">
(圖七、調整參數後結果)</p>
<p>丙、	座標轉置
由於拍照時難以拍到完全端正的靶，因此需要透過透視轉換將座標轉段至正座標，為此，我們決定先尋找靶框四個極點，再進行轉置運算重新建置新的座標系統</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002457.png" alt="">
(圖八、靶面轉置)</p>
<p>如上圖八所示，在找到四個極點後，可透過四個點構成的平面推導出其穿越靶面的法向量(上圖右邊淡藍色線)，藉由三個點所連成的兩條線，將其視為向量進行numpy的cross運算即可得到(具體實踐可參考function.py中的image_process的imageprocess副程式)。</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002540.png" alt="">
(圖九、影像處理程式細節索引)</p>
<p>而透過四個極點和指定的新座標點之間的轉換，使用了cv2的findHomography方法，得到了透視轉換矩陣。至此，已獲得了繪製結果的三大重要因素: 原圖法向量、轉置矩陣和座標點(包含記錄直線的那兩點)。</p>
<p>丁、	重新繪製資料
由每張圖的三大因素資料可整理出繪製結果圖所需要的資料，合併上dynamoDB中用戶儲存的資料，接著利用pillow在指定座標加上文字(比如日期、弓具設定、場地設定資料等)以及重新計算的座標平面繪製中靶散布圖與分析中靶情況，最後針對法向量和箭矢直線向量取arctan(x/y)得到各自的方向向量(弧度)就可以計算箭矢和法向量的角度差θ，在結果呈現圖上該偏轉的靶的法向量已知，只需要針對該法向量進行θ角度的旋轉，即可繪製出入射直線，如下示意圖所示:</p>
<p><img src="https://raw.githubusercontent.com/Ash0645/image_remote/main/20250207002613.png" alt="">
(圖十，原圖與結果回傳圖對比)</p>
<p>三、	雲端技術
鑒於本地伺服器架置流程繁複且對於AWS雲端服務的好奇，本次專案的伺服器、資料庫以及API端口皆使用AWS服務完成。主要使用的服務是serverless的Lambda和API Gateway進行與LINEBOT SDK的後端路由處理和程式邏輯撰寫，同時結合了儲存容器S3和NoSQL雲端資料庫DynamoDB分別進行圖片資料與使用者設定值的CRUD動作。也在建置的過程中學習到相當多的經驗與技巧，包含Lambda中環境的打包與上傳和與深度學習模型的串接等，雖然十分有挑戰性但能夠學習在雲端上部屬的過程十分有趣。</p>
<h4 id="參成果展示">參、	成果展示</h4>
<p>在最終實際建置完成後進行了用戶實際使用情況與錄影進行展示，影片中有加速圖片處理之速度，實際回傳需等待15秒至30秒:</p>
<h4 id="肆結論與未來展望">肆、	結論與未來展望</h4>
<p>最後綜觀成果而言，有初步達成當初理想的結果與實現，也在座標獲取與計算方面進行了教育其更精準的結果，之後期盼朝著用戶箭矢的區分與提升整體程式進程效率的方向進行改善。</p>
<h4 id="伍參考資料">伍、	參考資料</h4>
<p>[1] <a href="https://www.cnblogs.com/ybqjymy/p/12826850.html">https://www.cnblogs.com/ybqjymy/p/12826850.html</a>
[2] <a href="https://github.com/roboflow/notebooks/blob/main/notebooks/train-yolov8-instance-segmentation-on-custom-dataset.ipynb">https://github.com/roboflow/notebooks/blob/main/notebooks/train-yolov8-instance-segmentation-on-custom-dataset.ipynb</a>
[4] <a href="https://www.youtube.com/watch?v=wuZtUMEiKWY">https://www.youtube.com/watch?v=wuZtUMEiKWY</a>
[5] <a href="https://www.youtube.com/watch?v=pFiGSrRtaU4&#x26;t=293s">https://www.youtube.com/watch?v=pFiGSrRtaU4&#x26;t=293s</a>
[6] <a href="https://docs.ultralytics.com/tasks/segment/">https://docs.ultralytics.com/tasks/segment/</a>
[7] <a href="https://ithelp.ithome.com.tw/articles/10282541?sc=pt">https://ithelp.ithome.com.tw/articles/10282541?sc=pt</a></p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <div class="copyright" data-astro-cid-sz7xmlte>
&copy; 2025 Obsidian Blogger. All rights reserved.
</div> </div> </footer>  <script type="module" src="/_astro/BlogPost.astro_astro_type_script_index_0_lang.Bc1ryDJx.js"></script> </body> </html>